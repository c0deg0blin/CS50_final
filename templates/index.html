{% extends "layout.html" %}

{% block title %}
Main
{% endblock %}

{% block main %}
<div>
    <h1 style="display: inline">TripPacker: </h1>
    <!-- Checkbox counter -->
    <h1 style="display: inline" id="checkedCount"></h1>
        <h1 style="display: inline">/</h1>
        <h1 style="display: inline" id="allCheckboxes"></h1>
    <table>
        <thead>
            <tr>
                {% for column_name in column_names %}
                    {% if column_name.lower() == "id" %}
                        <th class="hidden_col">{{ column_name }}</th>
                    {% else %}
                        <th>{{ column_name }}</th>
                    {% endif %}
                {% endfor %}
            </tr>
        </thead>
        <tbody>
            <!-- Table rows get generated by updateTable function -->
        </tbody>
    </table>
    <button id="addButton"><strong> Add item </strong></button>
    <div id="dialog"
        style="display: none;
            position: absolute;
            top: 0; bottom: 0; left: 0; right: 0;
            width: 300px; height: 150px;
            margin: auto;
            background-color: #f0f0f0;
            padding: 20px;
            border-radius: 10px;">
        <label for="itemName">Item name:</label>
        <input style="width: 100%;" type="text" id="itemName" name="itemName">
        <button id="okButton">OK</button>
        <button id="cancelButton">Cancel</button>
    </div>
    <script>
        // Update the table when the window loads
        $(document).ready(function() {
            updateTable();
            updateCheckedCount();
        });

        var checkboxes = document.getElementsByClassName("packed_cb");
        function updateCheckedCount() {
            var checkedCount = $(".packed_cb:checkbox:checked").length;
            $("#checkedCount").text(checkedCount);
            var allCheckboxes = $(".packed_cb:checkbox").length;
            $("#allCheckboxes").text(allCheckboxes);
        }

        // When a checkbox is ticked
        $(document).on("change", ".packed_cb", function() {
            
            // Update the database with the new checkbox state
            const isChecked = $(this).prop("checked");
            const idValue = $(this).closest("tr").find("td.hidden_col").text(); // Assuming the class is "hidden_col"
            fetch("/", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json"
                },
                body: JSON.stringify({
                    action: "checkbox",
                    idValue: idValue,
                    isChecked: isChecked
                })
            });

            // Update the checked count on the page
            updateCheckedCount();
        });

        function updateTable() {
            // Get a list of the table headers
            var headers = $("thead th").map(function() {
                return $(this).text();
            }).get();

            $.ajax({
                url: "/get_table_data",
                type: "GET",
                dataType: "json",
                success: function(response) {
                    // Clear the existing table body
                    $("tbody").empty();

                    console.log(response);
                    // Iterate over each row
                    $.each(response["rows"], function(d_idx, row) {
                        // Create empty row
                        var tr = $("<tr>").attr("data-row", d_idx + 1);
                        
                        // Iterate over each header and fill row cells
                        $.each(headers, function(h_idx, header) {
                            if (header.toLowerCase() == "id") {
                                // Create a hidden cell for the id
                                $("<td>").addClass("hidden_col").text(row[header]).appendTo(tr);
                            } else if (header.toLowerCase() == "packed") {
                                // Create a checkbox
                                var input = $("<input>")
                                    .attr("type", "checkbox")
                                    .addClass("packed_cb")
                                    .attr("name", "packed_" + row["id"])
                                    .prop("checked", row[header] != 0); //Check it if value is not 0
                                $("<td>").append(input).appendTo(tr);
                            } else if (header.toLowerCase() == "category") {
                                // Create a <select> element
                                // var select = $("select").addClass("category-select");
                                var select = $("<select>").addClass("category-select");
                                // Populate with category options
                                $.each(response["categories"], function(cat_idx, category) {
                                    var option = $("<option>").text(category).val(category);
                                    select.append(option);
                                });
                                // Set the default value based on the category from the database
                                // console.log("Current category:");
                                console.log(row["category"]);
                                select.val(row["category"]);
                                $("<td>").append(select).appendTo(tr);
                            } else {
                                // Create a regular cell for other keys
                                $("<td>").text(row[header]).appendTo(tr);
                            }
                        });
                        // Append row to table
                        $("tbody").append(tr);
                    });

                    // Update the checked count after the table has been updated
                    updateCheckedCount();
                },
                error: function(jqXHR, textStatus, errorThrown) {
                    console.error("AJAX error:", textStatus, errorThrown);  // log any AJAX errors
                }
            });
        }

        // When the "Add item" button is clicked
        document.getElementById("addButton").addEventListener("click", function() {
            document.getElementById("dialog").style.display = "block";
        });
        
        // When the "OK" button is clicked in the "Add item" dialog
        document.getElementById("okButton").addEventListener("click", function() {
            var itemName = document.getElementById("itemName").value;

            if (itemName.trim() != "") {
                fetch("/", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json"
                },
                body: JSON.stringify({
                    action: "itemAdded",
                    itemName: itemName
                })
            })
            .then(response => {
                console.log(response);
                if (!response.ok) {
                    throw new Error("Network response was not ok");
                }
                return response.json();
            })
            .then(data => {
                updateTable();
            })
            .then(() => {
                updateCheckedCount();
            })
            .then(() => {
                console.log("New item added: ", itemName);
                document.getElementById("dialog").style.display = "none";
                document.getElementById("itemName").value = "";
            })
            .catch(error => console.error("Error:", error));

            }
        });
        
        document.getElementById("cancelButton").addEventListener("click", function() {
            console.log("Cancelled input of new item");
            document.getElementById("dialog").style.display = "none";
            document.getElementById("itemName").value = "";
        });

    </script>
{% endblock %}



