{% extends "layout.html" %}

{% block title %}
Main
{% endblock %}

{% block main %}
<div>
    <h1 style='display: inline'>TripPacker: </h1>
    <!-- Checkbox counter -->
    <h1 style='display: inline' id='checkedCount'></h1>
        <h1 style='display: inline'>/</h1>
        <h1 style='display: inline' id='allCheckboxes'></h1>
    <table>
        <thead>
            <tr>
                {% for column_name in column_names %}
                    {% if column_name.lower() == "id" %}
                        <th class='hidden_col'>{{ column_name }}</th>
                    {% else %}
                        <th>{{ column_name }}</th>
                    {% endif %}
                {% endfor %}
            </tr>
        </thead>
        <tbody>
            <!-- Table rows get generated by updateTable function -->
        </tbody>
    </table>
    <button id='addButton'><strong> Add item </strong></button>
    <script>
        // Update the table when the window loads
        $(document).ready(function() {
            updateTable();
            updateCheckedCount();
        });

        var checkboxes = document.getElementsByClassName('packed_cb');
        function updateCheckedCount() {
            var checkedCount = $('.packed_cb:checkbox:checked').length;
            $('#checkedCount').text(checkedCount);
            var allCheckboxes = $('.packed_cb:checkbox').length;
            $('#allCheckboxes').text(allCheckboxes);
        }

        // When a checkbox is ticked
        $(document).on('change', '.packed_cb', function() {
            
            // Update the database with the new checkbox state
            const isChecked = $(this).prop('checked');
            const idValue = $(this).closest('tr').find('td.hidden_col').text(); // Assuming the class is "hidden_col"
            fetch('/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    action: 'checkbox',
                    idValue: idValue,
                    isChecked: isChecked
                })
            });

            // Update the checked count on the page
            updateCheckedCount();
        });

        function updateTable() {
            // Store the table headers
            var headers = $('thead th').map(function() {
                return $(this).text();
            }).get();

            $.ajax({
                url: '/get_data',
                type: 'GET',
                dataType: 'json',
                success: function(data) {
                    // Clear the existing table body
                    $('tbody').empty();

                    // Iterate over each row
                    $.each(data, function(d_idx, row) {
                        // Create new row
                        var tr = $('<tr>').attr('data-row', d_idx + 1);
                        
                        // Iterate over each header
                        $.each(headers, function(h_idx, header) {
                            if (header.toLowerCase() == 'id') {
                                // Create a hidden cell for the id
                                $('<td>').addClass('hidden_col').text(row[header]).appendTo(tr);
                            } else if (header.toLowerCase() == 'packed') {
                                // Create a checkbox
                                var input = $('<input>')
                                    .attr('type', 'checkbox')
                                    .addClass('packed_cb')
                                    .attr('name', 'packed_' + row['id'])
                                    // .attr('id', 'cb_id')
                                    .prop('checked', row[header] != 0); //Check it if value is not 0
                                $('<td>').append(input).appendTo(tr);
                            } else {
                                // Create a regular cell for other keys
                                $('<td>').text(row[header]).appendTo(tr);
                            }
                        });
                        // Append row to table
                        $('tbody').append(tr);
                    });

                    // Update the checked count after the table has been updated
                    updateCheckedCount();
                },
                error: function(jqXHR, textStatus, errorThrown) {
                    console.error('AJAX error:', textStatus, errorThrown);  // log any AJAX errors
                }
            });
        }

        document.getElementById('addButton').addEventListener('click', function() {
            fetch('/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ action: 'addButton' })
            })
            .then(response => {
                console.log(response);
                if (!response.ok) {
                    throw new Error('Network response was not ok');
                }
                return response.json();
            })
            .then(data => {
                updateTable();
            })
            .then(() => {
                updateCheckedCount();
            })
            .catch(error => console.error('Error:', error));
        });

    </script>
{% endblock %}



