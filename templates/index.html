{% extends "layout.html" %}

{% block title %}
Main
{% endblock %}

{% block main %}
<div>
    <h1 style="display: inline">TripPacker: </h1>
    <!-- Checkbox counter -->
    <h1 style="display: inline" id="checkedCount"></h1>
        <h1 style="display: inline">/</h1>
        <h1 style="display: inline" id="allCheckboxes"></h1>
    <table id="TripPacker_table">
        <thead>
            <tr>
                {% for column_name in column_names %}
                    {% if column_name.lower() == "id" %}
                        <th class="hidden_col">{{ column_name }}</th>
                    {% else %}
                        <th>{{ column_name }}</th>
                    {% endif %}
                {% endfor %}
            </tr>
        </thead>
        <tbody>
            <!-- Table rows get generated by updateTable function -->
        </tbody>
    </table>
    <button id="addButton"><strong> Add item </strong></button>
    <div id="dialog"
        style="display: none;
            position: absolute;
            top: 0; bottom: 0; left: 0; right: 0;
            width: 300px; height: 150px;
            margin: auto;
            background-color: #f0f0f0;
            padding: 20px;
            border-radius: 10px;">
        <label for="itemName">Item name:</label>
        <input style="width: 100%;" type="text" id="itemName" name="itemName">
        <button id="okButton">OK</button>
        <button id="cancelButton">Cancel</button>
    </div>
    <script>
        // Update the table when the window loads
        $(document).ready(function() {
            updateTable();
            updateCheckedCount();
        });

        var checkboxes = document.getElementsByClassName("packed_cb");
        function updateCheckedCount() {
            var checkedCount = $(".packed_cb:checkbox:checked").length;
            $("#checkedCount").text(checkedCount);
            var allCheckboxes = $(".packed_cb:checkbox").length;
            $("#allCheckboxes").text(allCheckboxes);
        }

        // When a checkbox is ticked
        $(document).on("change", ".packed_cb", function() {
            
            // Update the database with the new checkbox state
            const isChecked = $(this).prop("checked");
            const idValue = $(this).closest("tr").find("td.hidden_col").text(); // Assuming the class is "hidden_col"
            fetch("/", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json"
                },
                body: JSON.stringify({
                    action: "checkbox",
                    idValue: idValue,
                    isChecked: isChecked
                })
            });

            // Update the checked count on the page
            updateCheckedCount();
        });
        
        function updateTable() {
            // Get a list of the table headers
            var headers = $("thead th").map(function() {
                return $(this).text();
            }).get();

            $.ajax({
                url: "/get_table_data",
                type: "GET",
                dataType: "json",
                success: function(response) {
                    // Clear the existing table body
                    $("tbody").empty();

                    // Iterate over each row
                    console.log(response);
                    $.each(response["rows"], function(d_idx, row) {
                        // Create empty row
                        var tr = $("<tr>").attr("data-row", d_idx + 1);
                        
                        // Iterate over each header and fill row cells
                        $.each(headers, function(h_idx, header) {
                            if (header.toLowerCase() == "id") {
                                // Create a hidden cell for the id
                                $("<td>").addClass("hidden_col").text(row[header]).appendTo(tr);
                            } else if (header.toLowerCase() == "packed") {
                                // Create a checkbox
                                var input = $("<input>")
                                    .attr("type", "checkbox")
                                    .addClass("packed_cb")
                                    .attr("name", "packed_" + row["id"])
                                    .prop("checked", row[header] != 0); //Check it if value is not 0
                                $("<td>").append(input).appendTo(tr);
                            } else if (header.toLowerCase() == "category") {
                                // Create a <select> element
                                var select = $("<select>").addClass("cat-sel");
                                // Populate with category options
                                $.each(response["categories"], function(cat_idx, category) {
                                    var option = $("<option>").text(category).val(category);
                                    select.append(option);
                                });
                                // Set the default value based on the category from the database
                                select.val(row["category"]);
                                $("<td>").append(select).appendTo(tr);
                            } else if (header.toLowerCase() == "luggage") {
                                // Create a <select> element
                                var select = $("<select>").addClass("lug-sel");
                                // Populate with luggage options
                                $.each(response["luggage_opts"], function(cat_idx, luggage) {
                                    var option = $("<option>").text(luggage).val(luggage);
                                    select.append(option);
                                });
                                // Set the default value based on the luggage from the database
                                select.val(row["luggage"]);
                                $("<td>").append(select).appendTo(tr);
                            } else {
                                // Create a regular cell for other keys
                                $("<td>").text(row[header]).appendTo(tr);
                            }
                        });
                        // Append row to table
                        $("tbody").append(tr);
                    });

                    // Update the checked count after the table has been updated
                    updateCheckedCount();
                },
                error: function(jqXHR, textStatus, errorThrown) {
                    console.error("AJAX error:", textStatus, errorThrown);  // log any AJAX errors
                }
            });
        }

        const table = document.getElementById("TripPacker_table");
        // Attach event listener to table
        table.addEventListener("change", function (event) {
            const target = event.target;
            // When a different category is selected in any category dropdown
            if (target.classList.contains("cat-sel")) {
                // Find the parent row of the dropdown
                const parentRow = target.closest("tr");
                const selected_cat = target.value;
                if (parentRow) {
                    // Retrieve the id for this row
                    const idValue = parentRow.querySelector(".hidden_col").textContent;
                    fetch("/", {
                        method: "POST",
                        headers: {
                            "Content-Type": "application/json"
                        },
                        body: JSON.stringify({
                            action: "category_changed",
                            id: idValue,
                            category: selected_cat
                        }),
                    })
                    .then((response) => response.json)
                    .then((data) => {
                        // Handle the response from the server (if needed)
                        console.log("Server response (category change):", data);
                    })
                    .catch((error) => {
                        console.error("Error sending data (category change):", error);
                    });
                }
            } else if (target.classList.contains("lug-sel")) {
                // When a different luggage is selected in any luggage dropdown
                // Find the parent row of the dropdown
                const parentRow = target.closest("tr");
                const selected_lug = target.value;
                if (parentRow) {
                    // Retrieve the id for this row
                    const idValue = parentRow.querySelector(".hidden_col").textContent;
                    fetch("/", {
                        method: "POST",
                        headers: {
                            "Content-Type": "application/json"
                        },
                        body: JSON.stringify({
                            action: "luggage_changed",
                            id: idValue,
                            luggage: selected_lug
                        }),
                    })
                    .then((response) => response.json)
                    .then((data) => {
                        // Handle the response from the server (if needed)
                        console.log("Server response (luggage change):", data);
                    })
                    .catch((error) => {
                        console.error("Error sending data (luggage change):", error);
                    });
                }
            }
        });

        // When the "Add item" button is clicked
        document.getElementById("addButton").addEventListener("click", function() {
            document.getElementById("dialog").style.display = "block";
            // Get the input box by its ID
            var inputBox = document.getElementById("itemName");
            // Set focus on the input box
            inputBox.focus();
        });
        
        // When the "OK" button is clicked in the "Add item" dialog
        document.getElementById("okButton").addEventListener("click", function() {
            var itemName = document.getElementById("itemName").value;

            if (itemName.trim() != "") {
                fetch("/", {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json"
                    },
                    body: JSON.stringify({
                        action: "itemAdded",
                        itemName: itemName
                    })
                })
                .then(response => {
                    console.log(response);
                    if (!response.ok) {
                        throw new Error("Network response was not ok");
                    }
                    return response.json();
                })
                .then(data => {
                    updateTable();
                })
                .then(() => {
                    updateCheckedCount();
                })
                .then(() => {
                    console.log("New item added: ", itemName);
                    document.getElementById("dialog").style.display = "none";
                    document.getElementById("itemName").value = "";
                })
                .catch(error => console.error("Error:", error));
            }
        });

        // When enter is pressed in the add item textbox, run same
        // action as when clicking the OK button.
        document.getElementById("itemName").addEventListener("keyup", function(event) {
            event.preventDefault(); 
            if (event.keyCode === 13) {
                document.getElementById("okButton").click();
            }
        });
        
        // When the cancel button is clicked
        document.getElementById("cancelButton").addEventListener("click", function() {
            console.log("Cancelled input of new item");
            document.getElementById("dialog").style.display = "none";
            document.getElementById("itemName").value = "";
        });

    </script>
{% endblock %}



