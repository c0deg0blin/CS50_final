{% extends "layout.html" %}

{% block title %}
Luggage
{% endblock %}

{% block main %}
<div>
    <h1 style="display: inline">Luggage</h1>
    <!-- Luggage counter (STRETCH GOAL) -->
</div>
<div>
    <table id="Luggage_table">
        <thead>
            <tr>
                {% for column_name in column_names %}
                    {% if column_name.lower() == "id" %}
                        <th class="id_col hidden_col">{{ column_name }}</th>
                    {% elif column_name == "DELETE_BUTTONS" %}
                        <th hidden>{{ column_name }}</th>
                    {% else %}
                        <th>{{ column_name }}</th>
                    {% endif %}
                {% endfor %}
            </tr>
        </thead>
        <tbody>
            <!-- Table rows get generated by updateTable function -->
        </tbody>
    </table>
</div>
<div>
    <button id="addButton"><strong>Add luggage</strong></button>
</div>
<div id="dialog"
    style="display: none;
        position: absolute;
        top: 0; bottom: 0; left: 0; right: 0;
        width: 300px; height: 150px;
        margin: auto;
        background-color: #f0f0f0;
        padding: 20px;
        border-radius: 10px;">
    <label for="luggageName">Luggage name:</label>
    <input style="width: 100%;" type="text" id="luggageName" name="luggageName">
    <button id="okButton">OK</button>
    <button id="cancelButton">Cancel</button>
</div>
<div>
    <!-- Navigation menu -->
    <ul>
        <li><a href="/">Packing list</a></li>
    </ul>
</div>

<script>
    // Update the table when the window loads
    $(document).ready(function() {
        updateTable();
    });

    function updateTable() {
        // Get a list of the table headers
        var headers = $("thead th").map(function() {
            return $(this).text();
        }).get();

        $.ajax({
            url: "/get_lugTable_data",
            type: "GET",
            dataType: "json",
            success: function(response) {
                // Clear the existing table body
                $("tbody").empty();

                // Iterate over each row
                $.each(response["rows"], function(d_idx, row) {
                    // Create empty row
                    var tr = $("<tr>").attr("data-row", d_idx + 1);

                    // Iterate over each header and fill row cells
                    $.each(headers, function(h_idx, header) {
                        if (header.toLowerCase() == "id") {
                            // Create a hidden cell for the id
                            $("<td>").addClass("id_col hidden_col").text(row[header]).appendTo(tr);
                            // $("<td>").addClass("id_col").text(row[header]).appendTo(tr);
                        } else if (header.toLowerCase() == "luggage") {
                            // Create a luggage element
                            var lug_input = $("<input>").addClass("lug-ren");
                            lug_input.val(row["luggage"])
                            $("<td>").append(lug_input).appendTo(tr);
                            } else if (header == "DELETE_BUTTONS") {
                                // Create a button element
                                var del_btn = $("<button>").addClass("del-btn");
                                del_btn.text("X");
                                $("<td>").append(del_btn).appendTo(tr);
                        }
                    })
                    // Append row to table
                    $("tbody").append(tr);
                })
            }
        })
    }
    
    // Get reference to table
    const table = document.getElementById("Luggage_table");

// Table event listener to pick up changes
    table.addEventListener("change", function (event) {
        const target = event.target;
        // When a different luggage is selected in any luggage dropdown
        if (target.classList.contains("lug-ren")) {
            // When a luggage name is changed
            // Find the parent row of the item
            const parentRow = target.closest("tr");
            if (parentRow) {
                // Retrieve the id for this row
                const idValue = parentRow.querySelector(".id_col").textContent;
                const luggage_name = target.value;
                fetch("/luggage", {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json"
                    },
                    body: JSON.stringify({
                        action: "luggage_renamed",
                        id: idValue,
                        luggage_name: luggage_name
                    })
                })
            }
        }
    });

    // Table event listener to pick up delete button clicks
    table.addEventListener("click", function (event) {
        const target = event.target;
        // When a X (delete item) button is clicked
        if (target.classList.contains("del-btn")) {
            // Find the parent row of the buttonm
            const parentRow = target.closest("tr");
            if (parentRow) {
                // Retrieve the id for this row
                const idValue = parentRow.querySelector(".id_col").textContent;
                fetch("/luggage", {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json"
                    },
                    body: JSON.stringify({
                        action: "delete_luggage",
                        id: idValue
                    }),
                })
                .then((response) => response.json)
                .then((data) => {
                    updateTable();
                    // Handle the response from the server (if needed)
                    console.log("Server response (luggage deletion):", data);
                })
                .catch((error) => {
                    console.error("Error sending data (luggage deletion):", error);
                });
            }
        }
    });

    // When the "Add luggage" button is clicked
    document.getElementById("addButton").addEventListener("click", function() {
        document.getElementById("dialog").style.display = "block";
        // Get the input box by its ID
        var inputBox = document.getElementById("luggageName");
        // Set focus on the input box
        inputBox.focus();
    });

    // When the "OK" button is clicked in the "Add luggage" dialog
    document.getElementById("okButton").addEventListener("click", function() {
        var luggageName = document.getElementById("luggageName").value;

        if (luggageName.trim() != "") {
            fetch("/luggage", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json"
                },
                body: JSON.stringify({
                    action: "luggageAdded",
                    luggageName: luggageName
                })
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error("Network response was not ok");
                }
                return response.json();
            })
            .then(data => {
                updateTable();
            })
            .then(() => {
                console.log("New item added: ", luggageName);
                document.getElementById("dialog").style.display = "none";
                document.getElementById("luggageName").value = "";
            })
            .catch(error => console.error("Error:", error));
        }
    });

    // When enter is pressed in the add luggage textbox, run same
    // action as when clicking the OK button.
    document.getElementById("luggageName").addEventListener("keyup", function(event) {
        event.preventDefault(); 
        if (event.keyCode === 13) {
            document.getElementById("okButton").click();
        }
    });
    
    // When the cancel button is clicked
    document.getElementById("cancelButton").addEventListener("click", function() {
        console.log("Cancelled input of new item");
        document.getElementById("dialog").style.display = "none";
        document.getElementById("luggageName").value = "";
    });
</script>

{% endblock %}
