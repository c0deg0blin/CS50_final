{% extends "layout.html" %}

{% block title %}
Categories
{% endblock %}

{% block main %}

<div>
    <h1 style="display: inline">Categories</h1>
    <!-- Category counter (STRETCH GOAL) -->
</div>
<div>
    <table id="Categories_table">
        <thead>
            <tr>
                {% for column_name in column_names %}
                    {% if column_name.lower() == "id" %}
                        <th class="id_col hidden_col">{{ column_name }}</th>
                    {% elif column_name == "DELETE_BUTTONS" %}
                        <th hidden>{{ column_name }}</th>
                    {% else %}
                        <th>{{ column_name }}</th>
                    {% endif %}
                {% endfor %}
            </tr>
        </thead>
        <tbody>
            <!-- Table rows get generated by updateTable function -->
        </tbody>
    </table>
</div>
<div>
    <button id="addButton"><strong>Add category</strong></button>
</div>
<div id="dialog"
    style="display: none;
        position: absolute;
        top: 0; bottom: 0; left: 0; right: 0;
        width: 300px; height: 150px;
        margin: auto;
        background-color: #f0f0f0;
        padding: 20px;
        border-radius: 10px;">
    <label for="categoryName">Category name:</label>
    <input style="width: 100%;" type="text" id="categoryName" name="categoryName">
    <button id="okButton">OK</button>
    <button id="cancelButton">Cancel</button>
</div>
<hr>
<div>
    <!-- Navigation menu -->
    <ul>
        <li><a href="/">Packing list</a></li>
    </ul>
</div>

<script>
    // Update the table when the window loads
    $(document).ready(function() {
        updateTable();
    });

    function updateTable() {
        // Get a list of the table headers
        var headers = $("thead th").map(function() {
            return $(this).text();
        }).get();

        $.ajax({
            url: "/get_catTable_data",
            type: "GET",
            dataType: "json",
            success: function(response) {
                // Clear the existing table body
                $("tbody").empty();

                // Iterate over each row
                $.each(response["rows"], function(d_idx, row) {
                    // Create empty row
                    var tr = $("<tr>").attr("data-row", d_idx + 1);

                    // Iterate over each header and fill row cells
                    $.each(headers, function(h_idx, header) {
                        if (header.toLowerCase() == "id") {
                            // Create a hidden cell for the id
                            $("<td>").addClass("id_col hidden_col").text(row[header]).appendTo(tr);
                        } else if (header.toLowerCase() == "category") {
                            // Create a category element
                            var cat_input = $("<input>").addClass("cat-ren");
                            cat_input.val(row["category"])
                            $("<td>").append(cat_input).appendTo(tr);
                        } else if (header == "DELETE_BUTTONS") {
                                // Create a delete button element
                                var del_btn = $("<button>").addClass("del-btn");
                                del_btn.text("X");
                                $("<td>")
                                    .addClass("centered_cell")
                                    .width("30px")
                                    .append(del_btn)
                                    .appendTo(tr);
                        }
                    })
                    // Append row to table
                    $("tbody").append(tr);
                })
            }
        })
    }

    // Get reference to table
    const table = document.getElementById("Categories_table");

    // Table event listener to pick up changes
    table.addEventListener("change", function (event) {
        const target = event.target;
        // When a different category is selected in any category dropdown
        if (target.classList.contains("cat-ren")) {
            // When a category name is changed
            // Find the parent row of the item
            const parentRow = target.closest("tr");
            if (parentRow) {
                // Retrieve the id for this row
                const idValue = parentRow.querySelector(".id_col").textContent;
                const category_name = target.value;
                fetch("/categories", {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json"
                    },
                    body: JSON.stringify({
                        action: "category_renamed",
                        id: idValue,
                        category_name: category_name
                    })
                })
            }
        }
    });

    // Table event listener to pick up delete button clicks
    table.addEventListener("click", function (event) {
        const target = event.target;
        // When a X (delete item) button is clicked
        if (target.classList.contains("del-btn")) {
            // Find the parent row of the buttonm
            const parentRow = target.closest("tr");
            if (parentRow) {
                // Retrieve the id for this row
                const idValue = parentRow.querySelector(".id_col").textContent;
                fetch("/categories", {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json"
                    },
                    body: JSON.stringify({
                        action: "delete_category",
                        id: idValue
                    }),
                })
                .then((response) => response.json)
                .then((data) => {
                    updateTable();
                    // Handle the response from the server (if needed)
                    console.log("Server response (category deletion):", data);
                })
                .catch((error) => {
                    console.error("Error sending data (category deletion):", error);
                });
            }
        }
    });

    // When the "Add category" button is clicked
    document.getElementById("addButton").addEventListener("click", function() {
        document.getElementById("dialog").style.display = "block";
        // Get the input box by its ID
        var inputBox = document.getElementById("categoryName");
        // Set focus on the input box
        inputBox.focus();
    });

    // When the "OK" button is clicked in the "Add category" dialog
    document.getElementById("okButton").addEventListener("click", function() {
        var categoryName = document.getElementById("categoryName").value;

        if (categoryName.trim() != "") {
            fetch("/categories", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json"
                },
                body: JSON.stringify({
                    action: "category_added",
                    categoryName: categoryName
                })
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error("Network response was not ok");
                }
                return response.json();
            })
            .then(data => {
                updateTable();
            })
            .then(() => {
                console.log("New item added: ", categoryName);
                document.getElementById("dialog").style.display = "none";
                document.getElementById("categoryName").value = "";
            })
            .catch(error => console.error("Error:", error));
        }
    });

    // When enter is pressed in the add category textbox, run same
    // action as when clicking the OK button.
    document.getElementById("categoryName").addEventListener("keyup", function(event) {
        event.preventDefault(); 
        if (event.keyCode === 13) {
            document.getElementById("okButton").click();
        }
    });
    
    // When the cancel button is clicked
    document.getElementById("cancelButton").addEventListener("click", function() {
        console.log("Cancelled input of new item");
        document.getElementById("dialog").style.display = "none";
        document.getElementById("categoryName").value = "";
    });
</script>

{% endblock %}
